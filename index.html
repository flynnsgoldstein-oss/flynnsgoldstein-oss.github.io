<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>זמני היום - Gra</title>
<link href="https://fonts.googleapis.com/css2?family=David+Libre&display=swap" rel="stylesheet">
<style>
  body {
    background: #000;
    color: #fff;
    font-family: 'David Libre', serif;
    text-align: center;
    direction: rtl;
    margin: 0;
    padding: 1em;
  }
  #currentTimeLabel {
    font-size: 2em;
    margin: 0.1em 0;
  }
  #currentTime {
    font-size: 4em;
    margin: 0.1em 0;
  }
  #currentDate {
    font-size: 1.5em;
    margin: 0.1em 0;
    color: #ccc;
  }
  h1 {
    font-size: 4em;
    margin: 0.1em 0;
  }
  p.time {
    font-size: 6em;  /* Main Gra time */
    margin: 0.05em 0;
    padding: 0.1em 0.4em;
    border: 3px dotted #fff;
    border-radius: 10px;
    display: inline-block;
    min-width: 18ch;
  }
  span.countdown {
    font-size: 4em; /* 2/3 of main time (6em) */
    display: block;
    margin-top: 0.05em;
    color: #ccc;
  }
</style>
</head>
<body>
  <div id="currentTimeLabel">השעה הנוכחית</div>
  <div id="currentTime">--:--:--</div>
  <div id="currentDate">--/--/----</div>

  <h1>סוף זמן קריאת שמע</h1>
  <p id="shemaTime" class="time">--:--<span id="shemaCountdown" class="countdown">--</span></p>

  <h1>סוף זמן תפילה</h1>
  <p id="tefillahTime" class="time">--:--<span id="tefillahCountdown" class="countdown">--</span></p>

  <script>
    let shemaTimeValue = null;
    let tefillahTimeValue = null;

    async function fetchJewishDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const url = `https://www.hebcal.com/converter?cfg=json&gy=${yyyy}&gm=${mm}&gd=${dd}&g2h=1`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        return `${data.hebrew} (${data.hd}/${data.hm}/${data.hy})`;
      } catch(e) {
        console.error('Error fetching Jewish date:', e);
        return '--';
      }
    }

    function updateCurrentTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText = now.toLocaleTimeString('he-IL', {hour12:false});
    }

    async function updateCurrentDate() {
      const jewishDate = await fetchJewishDate();
      const now = new Date();
      const gregDate = now.toLocaleDateString('en-US');
      document.getElementById('currentDate').innerText = `${jewishDate} | ${gregDate}`;
    }

    function updateCountdowns() {
      const now = new Date();
      function formatCountdown(targetTime) {
        if (!targetTime) return '--';
        if (now >= targetTime) return 'עבר זמנו ביטול קרנבו?';
        let diff = targetTime - now;
        const hours = String(Math.floor(diff / (1000*60*60))).padStart(2,'0');
        diff %= 1000*60*60;
        const minutes = String(Math.floor(diff / (1000*60))).padStart(2,'0');
        diff %= 1000*60;
        const seconds = String(Math.floor(diff / 1000)).padStart(2,'0');
        return `${hours}:${minutes}:${seconds}`;
      }
      document.getElementById('shemaCountdown').innerText = formatCountdown(shemaTimeValue);
      document.getElementById('tefillahCountdown').innerText = formatCountdown(tefillahTimeValue);
    }

    async function fetchZmanim() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const url = `https://www.hebcal.com/zmanim?cfg=json&geonameid=5178225&date=${yyyy}-${mm}-${dd}`;
      try {
        const res = await fetch(url);
        const data = await res.json();

        const shemaRaw = data.times.sofZmanShma;
        const tefillahRaw = data.times.sofZmanTfilla;

        shemaTimeValue = shemaRaw ? new Date(shemaRaw) : null;
        tefillahTimeValue = tefillahRaw ? new Date(tefillahRaw) : null;

        const shemaDisplay = shemaTimeValue
          ? shemaTimeValue.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12:false})
          : 'לא זמין';
        const tefillahDisplay = tefillahTimeValue
          ? tefillahTimeValue.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12:false})
          : 'לא זמין';

        document.getElementById('shemaTime').childNodes[0].nodeValue = shemaDisplay;
        document.getElementById('tefillahTime').childNodes[0].nodeValue = tefillahDisplay;

      } catch(err) {
        document.getElementById('shemaTime').childNodes[0].nodeValue = 'שגיאה';
        document.getElementById('tefillahTime').childNodes[0].nodeValue = 'שגיאה';
        console.error(err);
      }
    }

    // Initial fetch
    fetchZmanim();
    updateCurrentDate();

    // Update clocks every second
    setInterval(() => {
      updateCurrentTime();
      updateCountdowns();
    }, 1000);

    // Refresh Zmanim and Jewish date hourly
    setInterval(() => {
      fetchZmanim();
      updateCurrentDate();
    }, 60*60*1000);
  </script>
</body>
</html>
